// Message API provides CRUD operations for managing messages within Construct.
// Messages represent individual communications in conversations between users and AI agents.
// Each message belongs to a task and tracks content, role, usage metrics, and associated costs.
syntax = "proto3";

package construct.v1;

import "buf/validate/validate.proto";
import "construct/v1/common.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/furisto/construct/api/go/v1";

// MessageService provides operations for managing messages.
// Messages are individual communications within tasks, representing exchanges
// between users and AI agents in conversational workflows.
service MessageService {
  // CreateMessage creates a new message within a task.
  rpc CreateMessage(CreateMessageRequest) returns (CreateMessageResponse) {}

  // GetMessage retrieves a specific message by its unique identifier.
  rpc GetMessage(GetMessageRequest) returns (GetMessageResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  // ListMessages retrieves a list of messages with optional filtering and pagination.
  rpc ListMessages(ListMessagesRequest) returns (ListMessagesResponse) {
    option idempotency_level = NO_SIDE_EFFECTS;
  }

  // UpdateMessage modifies an existing message's content.
  rpc UpdateMessage(UpdateMessageRequest) returns (UpdateMessageResponse) {}

  // DeleteMessage removes a message from the system.
  rpc DeleteMessage(DeleteMessageRequest) returns (DeleteMessageResponse) {}
}

// Message represents a complete message entity with metadata, specification, and status.
message Message {
  // metadata contains system-managed, immutable information about the message.
  MessageMetadata metadata = 1;

  // spec contains the user-configurable specification of the message.
  MessageSpec spec = 2;

  // status contains the observed state and usage information of the message.
  MessageStatus status = 3;
}

// MessageMetadata contains system-managed, immutable information about a message.
message MessageMetadata {
  // id is the unique identifier for the message (UUID format).
  string id = 1 [(buf.validate.field).string.uuid = true];

  // created_at is the timestamp when the message was created.
  google.protobuf.Timestamp created_at = 2 [(buf.validate.field).required = true];

  // updated_at is the timestamp when the message was last modified.
  google.protobuf.Timestamp updated_at = 3 [(buf.validate.field).required = true];

  // task_id references the task this message belongs to (UUID format).
  string task_id = 4 [(buf.validate.field).string.uuid = true];

  // agent_id references the agent that generated this message, if applicable (UUID format, optional).
  optional string agent_id = 5 [(buf.validate.field).string.uuid = true];

  // model_id references the AI model used to generate this message, if applicable (UUID format, optional).
  optional string model_id = 6 [(buf.validate.field).string.uuid = true];

  // role indicates whether this message came from a user or assistant.
  MessageRole role = 7;
}

// MessageSpec defines the user-configurable specification of a message.
message MessageSpec {
  // content contains the actual message content (text, images, etc.).
  repeated MessagePart content = 1;
}

enum ContentStatus {
  CONTENT_STATUS_UNSPECIFIED = 0;
  CONTENT_STATUS_PARTIAL = 1;
  CONTENT_STATUS_COMPLETE = 2;
}

// MessageStatus contains the observed state and usage information of the message.
message MessageStatus {
  // usage tracks resource consumption and costs associated with generating this message.
  MessageUsage usage = 1;

  // content_state indicates the status of the message content.
  ContentStatus content_state = 2;

  // is_final_response indicates whether this message is the final response to the user's request.
  bool is_final_response = 3;
}

// MessageRole indicates the source/author of a message in the conversation.
enum MessageRole {
  // MESSAGE_ROLE_UNSPECIFIED indicates an unknown or unset message role.
  MESSAGE_ROLE_UNSPECIFIED = 0;

  // MESSAGE_ROLE_USER indicates the message was sent by a human user.
  MESSAGE_ROLE_USER = 1;

  // MESSAGE_ROLE_ASSISTANT indicates the message was generated by an AI assistant/agent.
  MESSAGE_ROLE_ASSISTANT = 2;
}

// MessagePart contains the actual content of a message, supporting different content types.
message MessagePart {
  message Text {
    string content = 1 [
      (buf.validate.field).string.min_len = 1,
      (buf.validate.field).string.max_len = 65536
    ];
  }

  // content holds the message payload in various formats.
  oneof data {
    // text contains plain text message content.
    Text text = 1;

    ToolCall tool_call = 2;

    // tool_result contains the result of a tool call.
    ToolResult tool_result = 3;
  }
}

// MessageUsage tracks resource consumption and associated costs for generating a message.
message MessageUsage {
  // input_tokens is the number of input tokens consumed to generate this message.
  int64 input_tokens = 1;

  // output_tokens is the number of output tokens generated in this message.
  int64 output_tokens = 2;

  // cache_write_tokens is the number of tokens written to cache during message generation.
  int64 cache_write_tokens = 3;

  // cache_read_tokens is the number of tokens read from cache during message generation.
  int64 cache_read_tokens = 4;

  // cost is the monetary cost associated with generating this message.
  double cost = 5;
}

// CreateMessageRequest contains the parameters needed to create a new message.
message CreateMessageRequest {
  // task_id references the task this message will belong to (UUID format).
  string task_id = 1 [(buf.validate.field).string.uuid = true];

  // content is the content of the message.
  repeated MessagePart content = 2 [
    (buf.validate.field).repeated.min_items = 1,
    (buf.validate.field).repeated.max_items = 25
  ];
}

// CreateMessageResponse contains the newly created message.
message CreateMessageResponse {
  // message is the newly created message instance.
  Message message = 1 [(buf.validate.field).required = true];
}

// GetMessageRequest specifies which message to retrieve.
message GetMessageRequest {
  // id is the unique identifier of the message to retrieve (UUID format).
  string id = 1 [(buf.validate.field).string.uuid = true];
}

// GetMessageResponse contains the requested message.
message GetMessageResponse {
  // message is the requested message instance.
  Message message = 1 [(buf.validate.field).required = true];
}

// ListMessagesRequest specifies parameters for listing messages with optional filtering and pagination.
message ListMessagesRequest {
  // Filter specifies criteria for narrowing the list of returned messages.
  message Filter {
    // task_ids filters messages by the tasks they belong to (UUID format, optional).
    optional string task_ids = 1 [(buf.validate.field).repeated.items.string.uuid = true];

    // agent_ids filters messages by the agents that generated them (UUID format, optional).
    optional string agent_ids = 2 [(buf.validate.field).repeated.items.string.uuid = true];

    // roles filters messages by their role (user or assistant, optional).
    optional MessageRole roles = 3 [(buf.validate.field).repeated.items.enum.defined_only = true];
  }

  // filter specifies criteria for narrowing the results.
  Filter filter = 1;

  // page_size limits the number of messages returned per page (1-100).
  optional int32 page_size = 2 [
    (buf.validate.field).int32.gte = 1,
    (buf.validate.field).int32.lte = 100
  ];

  // page_token is used for pagination to retrieve subsequent pages.
  string page_token = 3 [(buf.validate.field).string.max_len = 255];

  // sort_field specifies which field to sort results by.
  optional SortField sort_field = 4 [(buf.validate.field).enum.defined_only = true];

  // sort_order specifies the sorting direction (ascending or descending).
  optional SortOrder sort_order = 5 [(buf.validate.field).enum.defined_only = true];
}

// ListMessagesResponse contains the list of messages matching the request criteria.
message ListMessagesResponse {
  // messages is the list of messages matching the filter criteria.
  repeated Message messages = 1;

  // next_page_token is used to retrieve the next page of results (empty if no more pages).
  string next_page_token = 2;
}

// UpdateMessageRequest specifies which message to update and the new content.
message UpdateMessageRequest {
  // id is the unique identifier of the message to update (UUID format).
  string id = 1 [(buf.validate.field).string.uuid = true];

  // content is the new content for the message.
  repeated MessagePart content = 2 [
    (buf.validate.field).repeated.min_items = 1,
    (buf.validate.field).repeated.max_items = 25
  ];
}

// UpdateMessageResponse contains the updated message.
message UpdateMessageResponse {
  // message is the updated message instance.
  Message message = 1 [(buf.validate.field).required = true];
}

// DeleteMessageRequest specifies which message to delete.
message DeleteMessageRequest {
  // id is the unique identifier of the message to delete (UUID format).
  string id = 1 [(buf.validate.field).string.uuid = true];
}

// DeleteMessageResponse confirms the message deletion (empty response).
message DeleteMessageResponse {}

message ToolCall {
  message CodeInterpreterInput {
    string code = 1;
  }

  message CreateFileInput {
    string path = 1;
    string content = 2;
  }

  message EditFileInput {
    message DiffPair {
      string old = 1;
      string new = 2;
    }
    string path = 1;
    repeated DiffPair diffs = 2;
  }

  message ExecuteCommandInput {
    string command = 1;
  }

  message FindFileInput {
    string pattern = 1;
    string path = 2;
    string exclude_pattern = 3;
    int32 max_results = 4;
  }

  message GrepInput {
    string query = 1;
    string path = 2;
    string include_pattern = 3;
    string exclude_pattern = 4;
    bool case_sensitive = 5;
    int32 max_results = 6;
  }

  message HandoffInput {
    string requested_agent = 1;
    string handover_message = 2;
  }

  message AskUserInput {
    string question = 1;
    repeated string options = 2;
  }

  message ListFilesInput {
    string path = 1;
    bool recursive = 2;
  }

  message ReadFileInput {
    string path = 1;
  }

  message SubmitReportInput {
    string summary = 1;
    bool completed = 2;
    repeated string deliverables = 3;
    string next_steps = 4;
  }

  string id = 1;
  string tool_name = 2 [(buf.validate.field).required = true];
  oneof Input {
    CreateFileInput create_file = 3;
    EditFileInput edit_file = 4;
    ExecuteCommandInput execute_command = 5;
    FindFileInput find_file = 6;
    GrepInput grep = 7;
    HandoffInput handoff = 8;
    AskUserInput ask_user = 9;
    ListFilesInput list_files = 10;
    ReadFileInput read_file = 11;
    SubmitReportInput submit_report = 12;
    CodeInterpreterInput code_interpreter = 13;
  }
}

message ToolResult {
  message CodeInterpreterResult {
    string output = 1;
  }

  message CreateFileResult {
    bool overwritten = 1;
  }

  message EditFileResult {
    message PatchInfo {
      string patch = 1;
      int32 lines_added = 2;
      int32 lines_removed = 3;
    }

    string path = 1;
    PatchInfo patch_info = 2;
  }

  message ExecuteCommandResult {
    string stdout = 1;
    string stderr = 2;
    int32 exit_code = 3;
    string command = 4;
  }

  message FindFileResult {
    repeated string files = 1;
    int32 total_files = 2;
    int32 truncated_count = 3;
  }

  message GrepResult {
    message ContextLine {
      int32 line_number = 1;
      string content = 2;
    }

    message GrepMatch {
      string file_path = 1;
      int32 line_number = 2;
      string line_content = 3;
      repeated ContextLine context = 4;
    }

    repeated GrepMatch matches = 1;
    int32 total_matches = 2;
    int32 searched_files = 3;
  }

  message ListFilesResult {
    message DirectoryEntry {
      string name = 1;
      string type = 2;
      int64 size = 3;
    }

    string path = 1;
    repeated DirectoryEntry entries = 2;
  }

  message ReadFileResult {
    string path = 1;
    string content = 2;
  }

  message SubmitReportResult {
    string summary = 1;
    bool completed = 2;
    repeated string deliverables = 3;
    string next_steps = 4;
  }

  string id = 1;
  string tool_name = 2 [(buf.validate.field).required = true];

  oneof result {
    CreateFileResult create_file = 3;
    EditFileResult edit_file = 4;
    ExecuteCommandResult execute_command = 5;
    FindFileResult find_file = 6;
    GrepResult grep = 7;
    ListFilesResult list_files = 8;
    ReadFileResult read_file = 9;
    SubmitReportResult submit_report = 10;
    CodeInterpreterResult code_interpreter = 11;
  }

  ToolError error = 13;
}

message CreateFileToolResult {
  message Input {
    string file_path = 1;
    string file_content = 2;
  }
  Input input = 1;
  bool overwritten = 2;
}

message EditFileToolResult {
  string file_path = 1;
  string file_content = 2;
}

message ExecuteCommandToolResult {
  string command = 1;
  string output = 2;
  string error = 3;
}

message FindFileToolResult {
  string file_path = 1;
}

message GrepToolResult {
  string file_path = 1;
  string file_content = 2;
}

message HandoffToolResult {}

message ListFilesToolResult {}

message ReadFileToolResult {}

message SubmitReport {
  string summary = 1;
  bool completed = 2;
  repeated string deliverables = 3;
  string next_steps = 4;
}

message ToolError {
  string message = 1;
  map<string, string> details = 2;
}
